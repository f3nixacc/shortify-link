{% extends "base.html" %}

{% block title %}Dashboard - Shortify Link{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="{ showFilters: false }">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Analytics Dashboard</h1>

    <!-- Aggregate Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm font-medium">Total Links</p>
                    <p class="text-4xl font-bold mt-2">{{ total_links }}</p>
                </div>
                <svg class="w-16 h-16 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
            </div>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm font-medium">Total Clicks</p>
                    <p class="text-4xl font-bold mt-2">{{ total_clicks }}</p>
                </div>
                <svg class="w-16 h-16 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <button @click="showFilters = !showFilters" class="flex items-center justify-between w-full text-left font-semibold text-gray-800 mb-4">
            <span>Filters</span>
            <svg class="w-5 h-5 transition-transform" :class="{ 'rotate-180': showFilters }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>

        <form method="get" x-show="showFilters" x-cloak class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                <input type="date" name="date_from" value="{{ date_from }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                <input type="date" name="date_to" value="{{ date_to }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Min Clicks</label>
                <input type="number" name="min_clicks" value="{{ min_clicks }}" min="0"
                       placeholder="Minimum clicks"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">UTM Parameter Key</label>
                <input type="text" name="param_key" value="{{ param_key }}"
                       placeholder="e.g., utm_source"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">UTM Parameter Value</label>
                <input type="text" name="param_value" value="{{ param_value }}"
                       placeholder="e.g., facebook"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <div class="flex items-end">
                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Apply Filters
                </button>
                <a href="{% url 'links:dashboard' %}" class="ml-2 px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Top Links by Clicks -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Top Links by Clicks</h2>
        {% if top_links %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Short Code</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">URL</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Clicks</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for link in top_links %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <code class="text-indigo-600 font-mono">{{ link.short_code }}</code>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900 truncate max-w-md" title="{{ link.original_url }}">
                            {{ link.original_url|truncatechars:50 }}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                {{ link.clicks_count }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">
                            {{ link.created_at|date:"M d, Y" }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500">No links found.</p>
        {% endif %}
    </div>

    <!-- Recent Clicks -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Clicks (Last 50)</h2>
        {% if recent_clicks %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Short Code</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Referrer</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Params</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for click in recent_clicks %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <code class="text-indigo-600 font-mono">{{ click.short_link.short_code }}</code>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                            {{ click.clicked_at|date:"M d, Y H:i" }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">
                            {{ click.ip_address|default:"—" }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500 truncate max-w-xs" title="{{ click.referrer }}">
                            {{ click.referrer|default:"Direct"|truncatechars:30 }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">
                            {% if click.query_params %}
                            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">
                                {{ click.query_params|length }} params
                            </span>
                            {% else %}
                            —
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500">No clicks recorded yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
